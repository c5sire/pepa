```{r, echo = FALSE}
i = {{k}}
```

## 2.`r (i)`. Analysis for trait `r traits[i]`

```{r , echo = FALSE}
lc <- st4gi::checkdata01(traits[i], treat, rep, data)
if (lc$pmis <= maxp){
  
  
  if (lc$pmis > 0){
    #data[, traits[i]] <- st4gi::mveb(traits[i], treat, rep, data, maxp)[, 4]
    data[, treat] <- as.factor(data[, treat])
    datas <- names(data)[!names(data) %in% c(treat, "PED1")] # TODO replace "PED1" by a search
    x <- data[, datas]
    
    y <- data[, treat]
    data <- randomForest::rfImpute(x = x, y = y, do.trace = FALSE )
    data <- cbind(y, data)
    names(data)[1] <- treat
  }
  at <- suppressWarnings(st4gi::rcbd(traits[i], treat, rep, data, maxp))  
  
  model <- aov(data[, traits[i]] ~ data[, treat] + data[, rep])
}
```

`r if(lc$c1 == 1 & lc$c2 == 1 & lc$pmis <= maxp) {"You have fitted a linear model for a RCBD. The ANOVA table for your model is:"}`

```{r, echo=FALSE, comment = NA, results = 'asis'}
if (lc$pmis <= maxp) pander::pandoc.table(at, justify = "lrrrrr", digits = 6)
```

`r if(lc$c3 == 0 & lc$pmis <= maxp) paste("You have some missing values (", format(lc$pmis * 100, digits = 3), "%) and they have been estimated before running ANOVA.")`

```{r , echo = FALSE}
if (lc$pmis <= maxp) {
 print(paste("The p-value for treatments is",format(at[1, 5], digits = 6, scientific = FALSE) )  )
}

```

`r if(at[1, 5] < 0.05 & lc$pmis <= maxp) {"which is significant at the 5% level."} else {"which is not significant at the 5% level."}`

The means of your treatments are:
```{r, echo=FALSE, comment = NA, results = 'asis'}
if (lc$pmis <= maxp) {
x <- tapply(data[, traits[i]], data[, treat], mean)
x <- as.data.frame(x)
x <- cbind(row.names(x), x)
names(x) <- c(treat, traits[i])
row.names(x) = 1:nrow(x)
x[, 2] <- format(x[, 2], digits = 3)
x[, 2] <- as.numeric(x[, 2])
pander::pandoc.table(x, digits = 3, justify = "lr")
}
```

```{r, echo = FALSE, fig.height = 8, fig.width = 10}
if (lc$pmis <= maxp){
  z=x[order(x[traits[i]]), ]
  dotchart(z[,2], labels = z[,1])
}
```

`r if(lc$nt < 10 & lc$pmis <= maxp) {"It is always good to have some visualization of the data. Because the number of treatments in your experiment is not so big, we can plot the data for each treatment:"}`

```{r, echo = FALSE}
if (lc$nt < 10 & lc$pmis <= maxp) msdplot(traits[i], treat, data, conf = 1)
```


Do not forget the assumptions of the model. It is supposed that the error has a normal distribution with the same variance for all the treatments. The following plots must help you evaluate this:

```{r, echo = FALSE, fig.height = 5, fig.width = 10}
if (lc$pmis <= maxp){
  par(mfrow = c(1, 2))
  plot(model, which = 1)
  plot(model, which = 2)
}
```

Funnel shapes for the first plot may suggest heterogeneity of variances while departures from the theoretical normal line are symptoms of lack of normality.
